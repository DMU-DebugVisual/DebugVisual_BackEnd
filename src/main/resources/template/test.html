<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Collab Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-wrap: wrap; gap: 20px; padding: 10px; }
        .panel { border: 1px solid #ccc; padding: 10px; border-radius: 5px; min-width: 300px; }
        textarea { width: 400px; height: 300px; resize: vertical; }
        #log { width: 400px; height: 400px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; font-size: 12px; background-color: #f9f9f9; white-space: pre-wrap; }
        #participantsPanel { height: 400px; }
        #participantList { list-style: none; padding: 0; }
        #participantList li { padding: 5px; border-bottom: 1px solid #eee; }
        #participantList .owner { font-weight: bold; color: #b45309; }
        input { margin-bottom: 5px; padding: 4px; width: 95%; }
        button { width: 100%; padding: 8px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="panel">
    <h2>1. Connection</h2>
    <input type="text" id="roomId" placeholder="Enter Room ID">
    <input type="text" id="sessionId" placeholder="Enter Session ID">
    <input type="text" id="myUserId" placeholder="Enter My User ID">
    <input type="text" id="jwtToken" placeholder="Enter JWT Token">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()" disabled>Disconnect</button>
    <p style="font-size: 12px; color: #666;">
        <b>Note:</b> ê¶Œí•œ ë¶€ì—¬/íšŒìˆ˜, ê°•í‡´, ì„¸ì…˜ ì¼œê³  ë„ê¸°ëŠ” REST APIë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. (API ëª…ì„¸ì„œ ì°¸ê³ )
    </p>
</div>

<div class="panel" id="participantsPanel">
    <h2 id="roomNameTitle">Participants</h2>
    <ul id="participantList"></ul>
</div>

<div class="panel">
    <h2>2. Code Editor (Session)</h2>
    <textarea id="editor" onkeyup="sendCodeUpdate()" disabled></textarea>
</div>

<div class="panel">
    <h2>3. Received Messages Log</h2>
    <pre id="log"></pre>
</div>

<script>
    let stompClient = null;

    function log(message) {
        const logElement = document.getElementById('log');
        logElement.innerText += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    function updateParticipantList(roomState) {
        const listElement = document.getElementById('participantList');
        const roomNameTitle = document.getElementById('roomNameTitle');
        listElement.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°

        roomNameTitle.innerText = `${roomState.roomName} (Participants)`;

        // 1. ë°©ì¥ ì¶”ê°€
        const ownerItem = document.createElement('li');
        ownerItem.className = 'owner';
        ownerItem.innerText = `ğŸ‘‘ ${roomState.owner.userName} (${roomState.owner.userId})`;
        listElement.appendChild(ownerItem);

        // 2. ë‚˜ë¨¸ì§€ ì°¸ì—¬ì ì¶”ê°€
        roomState.participants.forEach(p => {
            const participantItem = document.createElement('li');
            participantItem.innerText = `ğŸ‘¤ ${p.userName} (${p.userId})`;
            listElement.appendChild(participantItem);
        });
    }

    function connect() {
        const roomId = document.getElementById('roomId').value;
        const sessionId = document.getElementById('sessionId').value;
        const myUserId = document.getElementById('myUserId').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!roomId || !jwtToken || !sessionId || !myUserId) {
            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const headers = { 'Authorization': 'Bearer ' + jwtToken };
        const socket = new SockJS('http://localhost:8080/ws-collab');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ ìì²´ ë¡œê·¸ ë„ê¸°

        stompClient.connect(headers, function (frame) {
            log('âœ… Connected to WebSocket Server.');
            document.querySelector('[onclick="connect()"]').disabled = true;
            document.querySelector('[onclick="disconnect()"]').disabled = false;
            document.getElementById('editor').disabled = false;

            // --- 1. ë°© ìƒíƒœ(ì°¸ì—¬ì ëª©ë¡) ì—…ë°ì´íŠ¸ êµ¬ë… ---
            const systemTopic = `/topic/room/${roomId}/system`;
            stompClient.subscribe(systemTopic, function (message) {
                const roomState = JSON.parse(message.body);
                log(`ğŸ”„ Received Room State Update. Owner: ${roomState.owner.userName}, Participants: ${roomState.participants.length}`);
                updateParticipantList(roomState);
            });
            log(`ğŸ‘‚ Subscribed to: ${systemTopic}`);

            // --- 2. ì½”ë“œ ìˆ˜ì • ë‚´ìš© êµ¬ë… ---
            const codeTopic = `/topic/room/${roomId}/session/${sessionId}/code`;
            stompClient.subscribe(codeTopic, function (message) {
                const received = JSON.parse(message.body);
                // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë‹¤ì‹œ ë°›ì•„ì„œ ì—ë””í„°ë¥¼ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ì²˜ë¦¬
                if (received.senderId !== myUserId) {
                    log(`ğŸ’» Code updated by ${received.senderName || received.senderId}.`);
                    document.getElementById('editor').value = received.content;
                }
            });
            log(`ğŸ‘‚ Subscribed to: ${codeTopic}`);

        }, function(error) {
            log('âŒ STOMP connection error: ' + error);
        });
    }

    function sendCodeUpdate() {
        if (stompClient && stompClient.connected) {
            const roomId = document.getElementById('roomId').value;
            const sessionId = document.getElementById('sessionId').value;
            const myUserId = document.getElementById('myUserId').value;
            const content = document.getElementById('editor').value;

            const destination = `/app/room/${roomId}/session/${sessionId}/code-update`;
            stompClient.send(destination, {}, JSON.stringify({
                'senderId': myUserId,
                'content': content
            }));
        }
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                log('ğŸ”Œ Disconnected from WebSocket Server.');
                document.querySelector('[onclick="connect()"]').disabled = false;
                document.querySelector('[onclick="disconnect()"]').disabled = true;
                document.getElementById('editor').disabled = true;
                document.getElementById('participantList').innerHTML = '';
                document.getElementById('roomNameTitle').innerText = 'Participants';
            });
        }
    }
</script>
</body>
</html>
