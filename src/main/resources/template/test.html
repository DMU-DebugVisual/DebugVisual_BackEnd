<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Collab Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-wrap: wrap; gap: 20px; padding: 10px; }
        .panel { border: 1px solid #ccc; padding: 10px; border-radius: 5px; min-width: 300px; }
        textarea { width: 400px; height: 300px; resize: vertical; }
        #log { width: 400px; height: 400px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; font-size: 12px; background-color: #f9f9f9; white-space: pre-wrap; }
        #participantsPanel { height: 400px; }
        #participantList { list-style: none; padding: 0; }
        #participantList li { padding: 5px; border-bottom: 1px solid #eee; }
        #participantList .owner { font-weight: bold; color: #b45309; }
        input { margin-bottom: 5px; padding: 4px; width: 95%; }
        button { width: 100%; padding: 8px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="panel">
    <h2>1. Connection</h2>
    <input type="text" id="roomId" placeholder="Enter Room ID">
    <input type="text" id="sessionId" placeholder="Enter Session ID">
    <input type="text" id="myUserId" placeholder="Enter My User ID">
    <input type="text" id="jwtToken" placeholder="Enter JWT Token">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()" disabled>Disconnect</button>
    <p style="font-size: 12px; color: #666;">
        <b>Note:</b> 권한 부여/회수, 강퇴, 세션 켜고 끄기는 REST API로 처리됩니다. (API 명세서 참고)
    </p>
</div>

<div class="panel" id="participantsPanel">
    <h2 id="roomNameTitle">Participants</h2>
    <ul id="participantList"></ul>
</div>

<div class="panel">
    <h2>2. Code Editor (Session)</h2>
    <textarea id="editor" onkeyup="sendCodeUpdate()" disabled></textarea>
</div>

<div class="panel">
    <h2>3. Received Messages Log</h2>
    <pre id="log"></pre>
</div>

<script>
    let stompClient = null;

    function log(message) {
        const logElement = document.getElementById('log');
        logElement.innerText += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    function updateParticipantList(roomState) {
        const listElement = document.getElementById('participantList');
        const roomNameTitle = document.getElementById('roomNameTitle');
        listElement.innerHTML = ''; // 목록 비우기

        roomNameTitle.innerText = `${roomState.roomName} (Participants)`;

        // 1. 방장 추가
        const ownerItem = document.createElement('li');
        ownerItem.className = 'owner';
        ownerItem.innerText = `👑 ${roomState.owner.userName} (${roomState.owner.userId})`;
        listElement.appendChild(ownerItem);

        // 2. 나머지 참여자 추가
        roomState.participants.forEach(p => {
            const participantItem = document.createElement('li');
            participantItem.innerText = `👤 ${p.userName} (${p.userId})`;
            listElement.appendChild(participantItem);
        });
    }

    function connect() {
        const roomId = document.getElementById('roomId').value;
        const sessionId = document.getElementById('sessionId').value;
        const myUserId = document.getElementById('myUserId').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!roomId || !jwtToken || !sessionId || !myUserId) {
            alert('모든 필드를 입력하세요.');
            return;
        }

        const headers = { 'Authorization': 'Bearer ' + jwtToken };
        const socket = new SockJS('http://localhost:8080/ws-collab');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // STOMP 라이브러리 자체 로그 끄기

        stompClient.connect(headers, function (frame) {
            log('✅ Connected to WebSocket Server.');
            document.querySelector('[onclick="connect()"]').disabled = true;
            document.querySelector('[onclick="disconnect()"]').disabled = false;
            document.getElementById('editor').disabled = false;

            // --- 1. 방 상태(참여자 목록) 업데이트 구독 ---
            const systemTopic = `/topic/room/${roomId}/system`;
            stompClient.subscribe(systemTopic, function (message) {
                const roomState = JSON.parse(message.body);
                log(`🔄 Received Room State Update. Owner: ${roomState.owner.userName}, Participants: ${roomState.participants.length}`);
                updateParticipantList(roomState);
            });
            log(`👂 Subscribed to: ${systemTopic}`);

            // --- 2. 코드 수정 내용 구독 ---
            const codeTopic = `/topic/room/${roomId}/session/${sessionId}/code`;
            stompClient.subscribe(codeTopic, function (message) {
                const received = JSON.parse(message.body);
                // 내가 보낸 메시지는 다시 받아서 에디터를 덮어쓰지 않도록 처리
                if (received.senderId !== myUserId) {
                    log(`💻 Code updated by ${received.senderName || received.senderId}.`);
                    document.getElementById('editor').value = received.content;
                }
            });
            log(`👂 Subscribed to: ${codeTopic}`);

        }, function(error) {
            log('❌ STOMP connection error: ' + error);
        });
    }

    function sendCodeUpdate() {
        if (stompClient && stompClient.connected) {
            const roomId = document.getElementById('roomId').value;
            const sessionId = document.getElementById('sessionId').value;
            const myUserId = document.getElementById('myUserId').value;
            const content = document.getElementById('editor').value;

            const destination = `/app/room/${roomId}/session/${sessionId}/code-update`;
            stompClient.send(destination, {}, JSON.stringify({
                'senderId': myUserId,
                'content': content
            }));
        }
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                log('🔌 Disconnected from WebSocket Server.');
                document.querySelector('[onclick="connect()"]').disabled = false;
                document.querySelector('[onclick="disconnect()"]').disabled = true;
                document.getElementById('editor').disabled = true;
                document.getElementById('participantList').innerHTML = '';
                document.getElementById('roomNameTitle').innerText = 'Participants';
            });
        }
    }
</script>
</body>
</html>
